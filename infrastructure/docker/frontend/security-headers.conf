# Security Headers Configuration for Investment Analysis Platform
# Production-ready security headers to protect against common attacks

# Content Security Policy - Restrict resource loading
add_header Content-Security-Policy "
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' 
               https://cdn.jsdelivr.net 
               https://unpkg.com 
               https://cdnjs.cloudflare.com;
    style-src 'self' 'unsafe-inline' 
              https://fonts.googleapis.com 
              https://cdn.jsdelivr.net 
              https://cdnjs.cloudflare.com;
    font-src 'self' 
             https://fonts.gstatic.com 
             https://cdn.jsdelivr.net 
             data:;
    img-src 'self' 
            data: 
            blob: 
            https://via.placeholder.com 
            https://images.unsplash.com;
    connect-src 'self' 
                wss: 
                ws: 
                https://api.polygon.io 
                https://finnhub.io 
                https://www.alphavantage.co 
                https://newsapi.org;
    frame-src 'none';
    object-src 'none';
    media-src 'self';
    worker-src 'self' blob:;
    child-src 'self';
    form-action 'self';
    base-uri 'self';
    manifest-src 'self';
" always;

# HTTP Strict Transport Security (HSTS)
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# Prevent MIME type sniffing
add_header X-Content-Type-Options "nosniff" always;

# XSS Protection
add_header X-XSS-Protection "1; mode=block" always;

# Clickjacking protection
add_header X-Frame-Options "DENY" always;

# Referrer Policy
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Feature Policy (Permissions Policy)
add_header Permissions-Policy "
    accelerometer=(),
    ambient-light-sensor=(),
    autoplay=(),
    battery=(),
    camera=(),
    cross-origin-isolated=(),
    display-capture=(),
    document-domain=(),
    encrypted-media=(),
    execution-while-not-rendered=(),
    execution-while-out-of-viewport=(),
    fullscreen=(self),
    geolocation=(),
    gyroscope=(),
    keyboard-map=(),
    magnetometer=(),
    microphone=(),
    midi=(),
    navigation-override=(),
    payment=(),
    picture-in-picture=(),
    publickey-credentials-get=(),
    screen-wake-lock=(),
    sync-xhr=(),
    usb=(),
    web-share=(),
    xr-spatial-tracking=()
" always;

# Remove server information
server_tokens off;
add_header X-Powered-By "";

# Expect-CT header for Certificate Transparency
add_header Expect-CT "max-age=86400, enforce" always;

# Cross-Origin Embedder Policy
add_header Cross-Origin-Embedder-Policy "require-corp" always;

# Cross-Origin Opener Policy
add_header Cross-Origin-Opener-Policy "same-origin" always;

# Cross-Origin Resource Policy
add_header Cross-Origin-Resource-Policy "same-site" always;

# Cache control for security-sensitive content
location ~* \.(html|htm)$ {
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
}

# Additional security for API endpoints
location /api/ {
    # Rate limiting is handled in main nginx config
    add_header X-API-Version "v1" always;
    add_header X-Request-ID $request_id always;
}

# Security headers for WebSocket connections
location /ws {
    add_header X-WebSocket-Protocol "investment-platform" always;
}

# Block common attack patterns
location ~* (eval\(|javascript:|vbscript:|onload=|onerror=|onclick=) {
    deny all;
    access_log off;
}

# Block access to sensitive files
location ~* \.(env|log|ini|conf|sql|bak|tmp)$ {
    deny all;
    access_log off;
}

# Block access to version control
location ~ /\.(git|svn|hg|bzr) {
    deny all;
    access_log off;
}