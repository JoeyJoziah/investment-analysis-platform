groups:
  - name: critical_alerts
    interval: 30s
    rules:
      # System Health Alerts
      - alert: ServiceDown
        expr: up == 0
        for: 2m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Service {{ $labels.job }} is down"
          description: "{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 2 minutes."
          runbook_url: "https://wiki.internal/runbooks/service-down"

      - alert: DatabaseConnectionFailure
        expr: db_connection_errors_total > 10
        for: 1m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Database connection failures detected"
          description: "More than 10 database connection errors in the last minute. Current value: {{ $value }}"
          runbook_url: "https://wiki.internal/runbooks/database-connection"

      - alert: BudgetExceeded
        expr: monthly_cost_projection_dollars > 50
        for: 5m
        labels:
          severity: critical
          team: finance
        annotations:
          summary: "Monthly cost projection exceeds budget"
          description: "Projected monthly cost is ${{ $value }}, exceeding the $50 budget limit"
          action: "Immediately switch to emergency mode and use cached data only"

      # Data Quality Critical Alerts
      - alert: CriticalDataQualityIssue
        expr: rate(data_quality_issues_total{severity="critical"}[5m]) > 0
        for: 1m
        labels:
          severity: critical
          team: data
        annotations:
          summary: "Critical data quality issues detected"
          description: "Critical data quality issues for {{ $labels.data_type }} - {{ $labels.issue_type }}"
          action: "Investigate immediately - data may be unusable"

      - alert: DataComplianceViolation
        expr: data_compliance_violations_total > 0
        for: 1m
        labels:
          severity: critical
          team: compliance
        annotations:
          summary: "Data compliance violation detected"
          description: "{{ $labels.compliance_type }} compliance violation: {{ $labels.violation_type }}"
          action: "Immediate investigation required for regulatory compliance"

      # Performance Critical Alerts
      - alert: APILatencyHigh
        expr: histogram_quantile(0.95, rate(api_request_duration_seconds_bucket[5m])) > 5
        for: 5m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "API latency is critically high"
          description: "95th percentile API latency is {{ $value }}s (threshold: 5s)"
          
      - alert: DatabaseQueryTimeout
        expr: histogram_quantile(0.95, rate(db_query_duration_seconds_bucket[5m])) > 10
        for: 5m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Database queries are timing out"
          description: "95th percentile query duration is {{ $value }}s"

      # Resource Exhaustion Alerts
      - alert: RateLimitExhausted
        expr: rate_limit_remaining{provider=~"alpha_vantage|finnhub|polygon"} == 0
        for: 1m
        labels:
          severity: critical
          team: data
        annotations:
          summary: "API rate limit exhausted for {{ $labels.provider }}"
          description: "No remaining API calls for {{ $labels.provider }}. Service degradation imminent."
          action: "Switch to alternative provider or cached data"

      - alert: CacheConnectionFailure
        expr: rate(cache_misses_total[1m]) == rate(cache_hits_total[1m]) + rate(cache_misses_total[1m])
        for: 2m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Cache system appears to be down"
          description: "100% cache miss rate detected, indicating cache connection failure"

      - alert: CircuitBreakerOpen
        expr: circuit_breaker_state > 0
        for: 5m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Circuit breaker {{ $labels.breaker_name }} is open"
          description: "Circuit breaker has been open for 5 minutes, indicating persistent failures"