global:
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alerts@investment-platform.local'
  smtp_auth_username: 'alerts@investment-platform.local'
  smtp_auth_password: 'changeme'

# Define templates for alert notifications
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Route tree for alerts
route:
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'investment-platform-alerts'
  routes:
  # Critical alerts - immediate notification
  - match:
      severity: critical
    receiver: 'critical-alerts'
    group_wait: 0s
    repeat_interval: 5m
  # Cost-related alerts
  - match:
      alertname: BudgetExceeded
    receiver: 'cost-alerts'
    repeat_interval: 30m
  - match:
      alertname: HighDailyCost
    receiver: 'cost-alerts'
    repeat_interval: 1h
  # Business metric alerts
  - match_re:
      alertname: '(LowRecommendationGeneration|NoStockDataUpdate|MLModelAccuracyDrop)'
    receiver: 'business-alerts'
    repeat_interval: 2h

# Alert notification receivers
receivers:
- name: 'investment-platform-alerts'
  webhook_configs:
  - url: 'http://backend:8000/api/alerts/webhook'
    title: 'Investment Platform Alert'
    text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'

- name: 'critical-alerts'
  webhook_configs:
  - url: 'http://backend:8000/api/alerts/webhook'
    title: 'CRITICAL: {{ .GroupLabels.alertname }}'
    text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
  # Add email notification for critical alerts
  email_configs:
  - to: 'admin@investment-platform.local'
    subject: 'CRITICAL Alert: {{ .GroupLabels.alertname }}'
    body: |
      Alert Details:
      {{ range .Alerts }}
      - Alert: {{ .Annotations.summary }}
      - Description: {{ .Annotations.description }}
      - Severity: {{ .Labels.severity }}
      - Time: {{ .StartsAt }}
      {{ end }}

- name: 'cost-alerts'
  webhook_configs:
  - url: 'http://backend:8000/api/alerts/cost-webhook'
    title: 'Cost Alert: {{ .GroupLabels.alertname }}'
    text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
  email_configs:
  - to: 'finance@investment-platform.local'
    subject: 'Cost Alert: {{ .GroupLabels.alertname }}'
    body: |
      Cost Alert:
      {{ range .Alerts }}
      - Alert: {{ .Annotations.summary }}
      - Current Usage: {{ .Annotations.description }}
      - Time: {{ .StartsAt }}
      {{ end }}
      
      Please review current usage and optimize costs if necessary.

- name: 'business-alerts'
  webhook_configs:
  - url: 'http://backend:8000/api/alerts/business-webhook'
    title: 'Business Metric Alert: {{ .GroupLabels.alertname }}'
    text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'

# Inhibit rules to prevent alert spam
inhibit_rules:
- source_match:
    severity: 'critical'
  target_match:
    severity: 'warning'
  equal: ['alertname', 'service']

- source_match:
    alertname: 'ServiceDown'
  target_match_re:
    alertname: '(HighAPILatency|HighAPIErrorRate|DatabaseConnectionsHigh)'
  equal: ['service']
