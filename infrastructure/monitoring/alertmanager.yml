# =============================================================================
# AlertManager Configuration
# Investment Analysis Platform
# =============================================================================
# This configuration supports:
#   - Email notifications via Gmail SMTP
#   - Webhook notifications to backend
#   - Slack notifications (optional)
#   - Environment variable substitution for credentials
# =============================================================================

global:
  # SMTP Configuration for Gmail
  # Use environment variables for credentials
  smtp_smarthost: '${SMTP_HOST}:${SMTP_PORT}'
  smtp_from: '${SMTP_FROM}'
  smtp_auth_username: '${SMTP_USER}'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true

  # Default resolve timeout
  resolve_timeout: 5m

# Define templates for alert notifications
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Route tree for alerts
route:
  group_by: ['alertname', 'severity']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'investment-platform-alerts'

  routes:
    # Critical alerts - immediate notification with email
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m
      continue: false

    # Cost and budget alerts - notify finance team
    - match:
        alertname: BudgetExceeded
      receiver: 'cost-alerts'
      repeat_interval: 30m
      continue: false

    - match:
        alertname: HighDailyCost
      receiver: 'cost-alerts'
      repeat_interval: 1h
      continue: false

    - match:
        alertname: APIRateLimitApproaching
      receiver: 'cost-alerts'
      repeat_interval: 15m
      continue: false

    # Business metric alerts
    - match_re:
        alertname: '(LowRecommendationGeneration|NoStockDataUpdate|MLModelAccuracyDrop)'
      receiver: 'business-alerts'
      repeat_interval: 2h
      continue: false

    # Backup alerts
    - match:
        alertname: BackupFailed
      receiver: 'critical-alerts'
      repeat_interval: 15m
      continue: false

    # Security alerts - highest priority
    - match:
        category: security
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m
      continue: false

# Alert notification receivers
receivers:
  # Default receiver for general platform alerts
  - name: 'investment-platform-alerts'
    webhook_configs:
      - url: 'http://backend:8000/api/alerts/webhook'
        send_resolved: true
        http_config:
          basic_auth:
            username: 'alertmanager'
            password: '${ALERTMANAGER_WEBHOOK_PASSWORD}'

  # Critical alerts - email + webhook
  - name: 'critical-alerts'
    webhook_configs:
      - url: 'http://backend:8000/api/alerts/webhook'
        send_resolved: true
        http_config:
          basic_auth:
            username: 'alertmanager'
            password: '${ALERTMANAGER_WEBHOOK_PASSWORD}'
    # Email notifications for critical alerts
    # Enable by setting ENABLE_EMAIL_ALERTS=true
    email_configs:
      - to: '${ALERT_EMAIL_TO}'
        send_resolved: true
        headers:
          Subject: '{{ template "email.investment_platform.subject" . }}'
        html: '{{ template "email.investment_platform.html" . }}'
        text: '{{ template "email.investment_platform.text" . }}'
        require_tls: true

  # Cost-related alerts - notify finance team
  - name: 'cost-alerts'
    webhook_configs:
      - url: 'http://backend:8000/api/alerts/cost-webhook'
        send_resolved: true
    # Email notifications for cost alerts
    email_configs:
      - to: '${COST_ALERT_EMAIL_TO}'
        send_resolved: true
        headers:
          Subject: '[COST ALERT] Investment Platform Budget Warning'
        html: '{{ template "email.investment_platform.html" . }}'
        text: '{{ template "email.investment_platform.text" . }}'
        require_tls: true

  # Business metric alerts
  - name: 'business-alerts'
    webhook_configs:
      - url: 'http://backend:8000/api/alerts/business-webhook'
        send_resolved: true

# Inhibit rules to prevent alert spam
inhibit_rules:
  # If a critical alert is firing, suppress related warning alerts
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service']

  # If a service is down, suppress related performance alerts
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      alertname: '(HighAPILatency|HighAPIErrorRate|DatabaseConnectionsHigh)'
    equal: ['service']

  # If database is down, suppress backup failure alerts
  - source_match:
      alertname: 'DatabaseDown'
    target_match:
      alertname: 'BackupFailed'
    equal: []

  # If backend is down, suppress API-related alerts
  - source_match:
      alertname: 'BackendDown'
    target_match_re:
      alertname: '(HighAPILatency|HighAPIErrorRate|APIRateLimitApproaching)'
    equal: []

# =============================================================================
# Environment Variables Required:
# =============================================================================
# SMTP_HOST=smtp.gmail.com
# SMTP_PORT=587
# SMTP_USER=your-alerts@gmail.com
# SMTP_PASSWORD=your-app-specific-password
# SMTP_FROM=Investment Platform <alerts@yourdomain.com>
# ALERT_EMAIL_TO=admin@yourdomain.com
# COST_ALERT_EMAIL_TO=finance@yourdomain.com
# ALERTMANAGER_WEBHOOK_PASSWORD=your-secure-password
# =============================================================================
