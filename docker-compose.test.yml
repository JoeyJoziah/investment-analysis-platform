# Test Docker Compose Configuration
# Investment Analysis Platform - Testing Stack
# Usage: docker-compose -f docker-compose.yml -f docker-compose.test.yml up --abort-on-container-exit

version: '3.8'

services:
  # Test database with minimal resources
  postgres:
    environment:
      POSTGRES_DB: test_investment_db
      POSTGRES_PASSWORD: test_password
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
    command: 
      - postgres
      - -c
      - shared_preload_libraries=timescaledb
      - -c
      - max_connections=50
      - -c
      - shared_buffers=128MB

  # Test Redis with minimal config
  redis:
    command: redis-server --requirepass test_password --maxmemory 256mb

  # Backend for testing
  backend:
    build:
      context: .
      dockerfile: ./infrastructure/docker/backend/Dockerfile
      target: test
    environment:
      - DATABASE_URL=postgresql://postgres:test_password@postgres:5432/test_investment_db
      - REDIS_URL=redis://:test_password@redis:6379/0
      - TESTING=true
      - DEBUG=false
      - LOG_LEVEL=WARNING
    volumes:
      - ./backend:/app/backend
      - ./tests:/app/tests
    depends_on:
      - postgres
      - redis
    command: >
      sh -c "
        # Wait for services
        while ! nc -z postgres 5432; do sleep 1; done;
        while ! nc -z redis 6379; do sleep 1; done;
        # Run migrations
        alembic upgrade head;
        # Run tests
        pytest tests/ -v --cov=backend --cov-report=html --cov-report=term-missing --junit-xml=test-results.xml
      "

  # Frontend testing
  frontend_test:
    build:
      context: ./frontend/web
      dockerfile: ../../infrastructure/docker/frontend/Dockerfile
      target: test
    volumes:
      - ./frontend/web/src:/app/src
      - ./frontend/web/public:/app/public
    environment:
      - NODE_ENV=test
      - CI=true
    command: npm test -- --coverage --watchAll=false

volumes:
  postgres_test_data: