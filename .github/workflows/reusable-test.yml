name: Reusable Test Workflow

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.11'
      node-version:
        description: 'Node.js version to use'
        required: false
        type: string
        default: '18'
      test-type:
        description: 'Type of tests to run'
        required: false
        type: string
        default: 'all'  # all, backend, frontend, integration
      skip-slow-tests:
        description: 'Skip slow running tests'
        required: false
        type: boolean
        default: false
      upload-coverage:
        description: 'Upload coverage reports'
        required: false
        type: boolean
        default: true
    secrets:
      codecov-token:
        description: 'Codecov token for coverage upload'
        required: false
      database-url:
        description: 'Database URL for testing'
        required: false
      redis-url:
        description: 'Redis URL for testing'
        required: false
      jwt-secret:
        description: 'JWT secret for testing'
        required: false
    outputs:
      backend-coverage:
        description: 'Backend test coverage percentage'
        value: ${{ jobs.backend-tests.outputs.coverage }}
      frontend-coverage:
        description: 'Frontend test coverage percentage'  
        value: ${{ jobs.frontend-tests.outputs.coverage }}
      test-results:
        description: 'Overall test results'
        value: ${{ jobs.test-summary.outputs.results }}

env:
  PYTHON_VERSION: ${{ inputs.python-version }}
  NODE_VERSION: ${{ inputs.node-version }}

jobs:
  # Backend Tests
  backend-tests:
    runs-on: ubuntu-latest
    if: inputs.test-type == 'all' || inputs.test-type == 'backend'
    outputs:
      coverage: ${{ steps.coverage.outputs.percentage }}
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ env.PYTHON_VERSION }}-
          ${{ runner.os }}-pip-

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client build-essential libpq-dev

    - name: Install TA-Lib
      run: |
        wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
        tar -xzf ta-lib-0.4.0-src.tar.gz
        cd ta-lib/ && ./configure --prefix=/usr && make && sudo make install

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Set up test environment
      run: |
        cat << EOF > .env
        DATABASE_URL=${{ secrets.database-url || 'postgresql://postgres:testpass@localhost:5432/test_db' }}
        REDIS_URL=${{ secrets.redis-url || 'redis://localhost:6379/0' }}
        JWT_SECRET_KEY=${{ secrets.jwt-secret || 'test-secret-key' }}
        APP_ENV=testing
        DEBUG=True
        EOF

    - name: Wait for services
      run: |
        until pg_isready -h localhost -p 5432 -U postgres; do
          echo "Waiting for PostgreSQL..."
          sleep 2
        done

    - name: Run database migrations
      run: alembic upgrade head

    - name: Run backend tests
      run: |
        TEST_MARKERS=""
        if [[ "${{ inputs.skip-slow-tests }}" == "true" ]]; then
          TEST_MARKERS="-m 'not slow'"
        fi
        
        pytest backend/tests/ \
          $TEST_MARKERS \
          --cov=backend \
          --cov-report=xml:backend-coverage.xml \
          --cov-report=html:backend-htmlcov \
          --cov-report=term-missing \
          --junitxml=backend-test-results.xml \
          -v

    - name: Extract coverage percentage
      id: coverage
      run: |
        if [ -f backend-coverage.xml ]; then
          COVERAGE=$(python -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('backend-coverage.xml')
          root = tree.getroot()
          line_rate = float(root.attrib['line-rate'])
          print(f'{line_rate * 100:.1f}')
          ")
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
        else
          echo "percentage=0" >> $GITHUB_OUTPUT
        fi

    - name: Upload coverage to Codecov
      if: inputs.upload-coverage == true && secrets.codecov-token != ''
      uses: codecov/codecov-action@v4
      with:
        file: ./backend-coverage.xml
        flags: backend
        name: backend-coverage
      env:
        CODECOV_TOKEN: ${{ secrets.codecov-token }}

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: backend-test-results
        path: |
          backend-test-results.xml
          backend-coverage.xml
          backend-htmlcov/

  # Frontend Tests
  frontend-tests:
    runs-on: ubuntu-latest
    if: inputs.test-type == 'all' || inputs.test-type == 'frontend'
    outputs:
      coverage: ${{ steps.coverage.outputs.percentage }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/web/package-lock.json

    - name: Install dependencies
      working-directory: frontend/web
      run: npm ci

    - name: Run frontend tests
      working-directory: frontend/web
      run: |
        TEST_ARGS="--coverage --ci --watchAll=false"
        if [[ "${{ inputs.skip-slow-tests }}" == "true" ]]; then
          TEST_ARGS="$TEST_ARGS --testNamePattern='^(?!.*slow).*$'"
        fi
        
        npm test -- $TEST_ARGS --testResultsProcessor=jest-junit
      env:
        CI: true
        JEST_JUNIT_OUTPUT_DIR: ./test-results
        JEST_JUNIT_OUTPUT_NAME: results.xml

    - name: Extract coverage percentage
      id: coverage
      working-directory: frontend/web
      run: |
        if [ -f coverage/lcov.info ]; then
          # Extract coverage from lcov.info or coverage-summary.json
          COVERAGE=$(node -e "
          try {
            const summary = require('./coverage/coverage-summary.json');
            console.log(summary.total.lines.pct || '0');
          } catch (e) {
            console.log('0');
          }
          ")
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
        else
          echo "percentage=0" >> $GITHUB_OUTPUT
        fi

    - name: Upload coverage to Codecov
      if: inputs.upload-coverage == true && secrets.codecov-token != ''
      uses: codecov/codecov-action@v4
      with:
        files: ./frontend/web/coverage/lcov.info
        flags: frontend
        name: frontend-coverage
      env:
        CODECOV_TOKEN: ${{ secrets.codecov-token }}

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: frontend-test-results
        path: |
          frontend/web/test-results/
          frontend/web/coverage/

  # Integration Tests
  integration-tests:
    runs-on: ubuntu-latest
    if: inputs.test-type == 'all' || inputs.test-type == 'integration'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create test environment file
      run: |
        cat << EOF > .env
        DATABASE_URL=postgresql://postgres:testpass@postgres:5432/investment_db
        REDIS_URL=redis://redis:6379/0
        JWT_SECRET_KEY=test-secret-key-integration
        APP_ENV=testing
        DEBUG=True
        TEST_DB_PASSWORD=testpass
        TEST_JWT_SECRET_KEY=test-secret-key-integration
        ALPHA_VANTAGE_API_KEY=demo
        FINNHUB_API_KEY=demo
        POLYGON_API_KEY=demo
        NEWS_API_KEY=demo
        EOF

    - name: Run integration tests
      run: |
        docker-compose -f docker-compose.test.yml up --build --abort-on-container-exit --exit-code-from backend
        docker-compose -f docker-compose.test.yml down -v

    - name: Upload integration results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: |
          integration-results/

  # Test Summary
  test-summary:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, integration-tests]
    if: always()
    outputs:
      results: ${{ steps.summary.outputs.results }}
    
    steps:
    - name: Generate test summary
      id: summary
      run: |
        BACKEND_STATUS="${{ needs.backend-tests.result }}"
        FRONTEND_STATUS="${{ needs.frontend-tests.result }}"
        INTEGRATION_STATUS="${{ needs.integration-tests.result }}"
        
        BACKEND_COVERAGE="${{ needs.backend-tests.outputs.coverage || '0' }}"
        FRONTEND_COVERAGE="${{ needs.frontend-tests.outputs.coverage || '0' }}"
        
        # Determine overall status
        OVERALL_STATUS="success"
        if [[ "$BACKEND_STATUS" == "failure" ]] || [[ "$FRONTEND_STATUS" == "failure" ]] || [[ "$INTEGRATION_STATUS" == "failure" ]]; then
          OVERALL_STATUS="failure"
        fi
        
        # Create results JSON
        RESULTS=$(cat << EOF
        {
          "overall_status": "$OVERALL_STATUS",
          "backend": {
            "status": "$BACKEND_STATUS",
            "coverage": "$BACKEND_COVERAGE"
          },
          "frontend": {
            "status": "$FRONTEND_STATUS", 
            "coverage": "$FRONTEND_COVERAGE"
          },
          "integration": {
            "status": "$INTEGRATION_STATUS"
          }
        }
        EOF
        )
        
        echo "results=$RESULTS" >> $GITHUB_OUTPUT
        
        # Create summary for step summary
        echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status | Coverage |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|----------|" >> $GITHUB_STEP_SUMMARY
        echo "| Backend Tests | $BACKEND_STATUS | $BACKEND_COVERAGE% |" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend Tests | $FRONTEND_STATUS | $FRONTEND_COVERAGE% |" >> $GITHUB_STEP_SUMMARY
        echo "| Integration Tests | $INTEGRATION_STATUS | - |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Overall Status**: $OVERALL_STATUS" >> $GITHUB_STEP_SUMMARY