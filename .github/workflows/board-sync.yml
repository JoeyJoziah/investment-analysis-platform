# GitHub Projects Board Synchronization Workflow
# Investment Analysis Platform
#
# Automatically syncs issues, PRs, and project board state
# Triggers: Issue/PR events, scheduled daily, manual dispatch

name: Board Sync

on:
  # Trigger on issue events
  issues:
    types: [opened, edited, closed, reopened, labeled, unlabeled, assigned]

  # Trigger on PR events
  pull_request:
    types: [opened, closed, merged, labeled]

  # Daily sync
  schedule:
    - cron: '0 6 * * *'  # 6 AM UTC daily

  # Manual trigger
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'Type of sync to perform'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - issues-only
          - board-only
          - report

permissions:
  contents: read
  issues: write
  pull-requests: write
  repository-projects: write

env:
  PROJECT_TITLE: "Investment Analysis Platform"

jobs:
  # Sync on issue events
  issue-sync:
    name: Sync Issue to Board
    runs-on: ubuntu-latest
    if: github.event_name == 'issues'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Project ID
        id: project
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find or note project doesn't exist
          PROJECT_ID=$(gh project list --owner ${{ github.repository_owner }} --format json | \
            jq -r '.projects[] | select(.title == "${{ env.PROJECT_TITLE }}") | .id' || echo "")

          if [ -z "$PROJECT_ID" ]; then
            echo "Project not found - will be created on manual sync"
            echo "project_exists=false" >> $GITHUB_OUTPUT
          else
            echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
            echo "project_exists=true" >> $GITHUB_OUTPUT
          fi

      - name: Add Issue to Project
        if: steps.project.outputs.project_exists == 'true' && github.event.action == 'opened'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh project item-add ${{ steps.project.outputs.project_id }} \
            --owner ${{ github.repository_owner }} \
            --url ${{ github.event.issue.html_url }} || true

      - name: Update Issue Labels on Close
        if: github.event.action == 'closed'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Add completed label if not present
          gh issue edit ${{ github.event.issue.number }} --add-label "status:completed" || true

  # Sync on PR events
  pr-sync:
    name: Sync PR to Board
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Project ID
        id: project
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PROJECT_ID=$(gh project list --owner ${{ github.repository_owner }} --format json | \
            jq -r '.projects[] | select(.title == "${{ env.PROJECT_TITLE }}") | .id' || echo "")

          if [ -n "$PROJECT_ID" ]; then
            echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
            echo "project_exists=true" >> $GITHUB_OUTPUT
          else
            echo "project_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Add PR to Project
        if: steps.project.outputs.project_exists == 'true' && github.event.action == 'opened'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh project item-add ${{ steps.project.outputs.project_id }} \
            --owner ${{ github.repository_owner }} \
            --url ${{ github.event.pull_request.html_url }} || true

      - name: Handle PR Merge
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "PR merged: ${{ github.event.pull_request.title }}"
          # Find and close related issues
          BODY="${{ github.event.pull_request.body }}"
          if [[ "$BODY" =~ (Closes|Fixes|Resolves)[[:space:]]*#([0-9]+) ]]; then
            ISSUE_NUM="${BASH_REMATCH[2]}"
            echo "Related issue: #$ISSUE_NUM"
          fi

  # Scheduled full sync
  scheduled-sync:
    name: Scheduled Board Sync
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Full Sync
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Running scheduled board sync..."

          # Ensure project exists
          PROJECT_ID=$(gh project list --owner ${{ github.repository_owner }} --format json | \
            jq -r '.projects[] | select(.title == "${{ env.PROJECT_TITLE }}") | .id' || echo "")

          if [ -z "$PROJECT_ID" ]; then
            echo "Creating project..."
            PROJECT_ID=$(gh project create --owner ${{ github.repository_owner }} \
              --title "${{ env.PROJECT_TITLE }}" --format json | jq -r '.id')
          fi

          echo "Project ID: $PROJECT_ID"

          # Sync all open issues
          echo "Syncing open issues..."
          gh issue list --state open --json url --jq '.[].url' | while read -r url; do
            gh project item-add "$PROJECT_ID" --owner ${{ github.repository_owner }} --url "$url" 2>/dev/null || true
          done

          # Sync open PRs
          echo "Syncing open PRs..."
          gh pr list --state open --json url --jq '.[].url' | while read -r url; do
            gh project item-add "$PROJECT_ID" --owner ${{ github.repository_owner }} --url "$url" 2>/dev/null || true
          done

          echo "Sync complete"

      - name: Generate Report
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## Board Sync Report - $(date +'%Y-%m-%d')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Issue Summary" >> $GITHUB_STEP_SUMMARY
          OPEN=$(gh issue list --state open --json number --jq 'length')
          CLOSED=$(gh issue list --state closed --json number --jq 'length')
          echo "- Open issues: $OPEN" >> $GITHUB_STEP_SUMMARY
          echo "- Closed issues: $CLOSED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Pull Request Summary" >> $GITHUB_STEP_SUMMARY
          PR_OPEN=$(gh pr list --state open --json number --jq 'length')
          echo "- Open PRs: $PR_OPEN" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Recent Activity" >> $GITHUB_STEP_SUMMARY
          echo "#### Latest Issues" >> $GITHUB_STEP_SUMMARY
          gh issue list --limit 5 --json number,title,state \
            --template '{{range .}}- #{{.number}}: {{.title}} ({{.state}}){{"\n"}}{{end}}' >> $GITHUB_STEP_SUMMARY

  # Manual sync
  manual-sync:
    name: Manual Board Sync
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Requested Sync
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SYNC_TYPE: ${{ github.event.inputs.sync_type }}
        run: |
          echo "Running $SYNC_TYPE sync..."

          # Get or create project
          PROJECT_ID=$(gh project list --owner ${{ github.repository_owner }} --format json | \
            jq -r '.projects[] | select(.title == "${{ env.PROJECT_TITLE }}") | .id' || echo "")

          if [ -z "$PROJECT_ID" ]; then
            echo "Creating project..."
            PROJECT_ID=$(gh project create --owner ${{ github.repository_owner }} \
              --title "${{ env.PROJECT_TITLE }}" --format json | jq -r '.id')

            # Create fields
            gh project field-create "$PROJECT_ID" --owner ${{ github.repository_owner }} \
              --name "Priority" --data-type "SINGLE_SELECT" \
              --single-select-options "ðŸ”´ Critical,ðŸŸ¡ High,ðŸŸ¢ Medium,âšª Low" 2>/dev/null || true

            gh project field-create "$PROJECT_ID" --owner ${{ github.repository_owner }} \
              --name "Agent Type" --data-type "SINGLE_SELECT" \
              --single-select-options "infrastructure-devops-swarm,data-ml-pipeline-swarm,financial-analysis-swarm,backend-api-swarm,ui-visualization-swarm" 2>/dev/null || true

            gh project field-create "$PROJECT_ID" --owner ${{ github.repository_owner }} \
              --name "Complexity" --data-type "SINGLE_SELECT" \
              --single-select-options "XS (< 1 hour),S (1-4 hours),M (1-2 days),L (3-5 days),XL (1+ week)" 2>/dev/null || true
          fi

          echo "Project ID: $PROJECT_ID"

          case "$SYNC_TYPE" in
            full|issues-only)
              echo "Syncing issues..."
              gh issue list --state open --json url --jq '.[].url' | while read -r url; do
                gh project item-add "$PROJECT_ID" --owner ${{ github.repository_owner }} --url "$url" 2>/dev/null || true
              done
              ;;
          esac

          case "$SYNC_TYPE" in
            full|board-only)
              echo "Syncing PRs..."
              gh pr list --state open --json url --jq '.[].url' | while read -r url; do
                gh project item-add "$PROJECT_ID" --owner ${{ github.repository_owner }} --url "$url" 2>/dev/null || true
              done
              ;;
          esac

          echo "Sync complete"

      - name: Generate Report
        if: github.event.inputs.sync_type == 'report' || github.event.inputs.sync_type == 'full'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## Manual Sync Report - $(date +'%Y-%m-%d %H:%M')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Sync type: ${{ github.event.inputs.sync_type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Issue Summary" >> $GITHUB_STEP_SUMMARY
          OPEN=$(gh issue list --state open --json number --jq 'length')
          CLOSED=$(gh issue list --state closed --json number --jq 'length')
          echo "- Open issues: $OPEN" >> $GITHUB_STEP_SUMMARY
          echo "- Closed issues: $CLOSED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Open Issues by Priority" >> $GITHUB_STEP_SUMMARY
          for label in "priority:high" "priority:medium" "priority:low"; do
            COUNT=$(gh issue list --state open --label "$label" --json number --jq 'length' 2>/dev/null || echo "0")
            echo "- $label: $COUNT" >> $GITHUB_STEP_SUMMARY
          done

  # Notion sync job
  notion-sync:
    name: Sync to Notion
    runs-on: ubuntu-latest
    needs: [scheduled-sync, manual-sync]
    if: |
      always() &&
      (needs.scheduled-sync.result == 'success' || needs.manual-sync.result == 'success')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests pyyaml

      - name: Sync to Notion Database
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        run: |
          if [[ -z "$NOTION_TOKEN" ]]; then
            echo "Notion token not configured, skipping Notion sync"
            exit 0
          fi

          # Read database ID from config
          DATABASE_ID=""
          if [[ -f ".github/board-sync.yml" ]]; then
            DATABASE_ID=$(grep "database_id:" .github/board-sync.yml | awk '{print $2}' | tr -d '"' || echo "")
          fi

          if [[ -z "$DATABASE_ID" ]]; then
            echo "Notion database ID not configured in .github/board-sync.yml"
            exit 0
          fi

          python << 'EOF'
          import os
          import json
          import requests

          NOTION_TOKEN = os.environ.get('NOTION_TOKEN', '')
          GITHUB_TOKEN = os.environ.get('GH_TOKEN', '')
          DATABASE_ID = os.environ.get('DATABASE_ID', '2f3b9fc9-1d9d-8026-9719-f82b0e311f50')
          REPO = os.environ.get('GITHUB_REPOSITORY', '')

          notion_headers = {
              "Authorization": f"Bearer {NOTION_TOKEN}",
              "Content-Type": "application/json",
              "Notion-Version": "2022-06-28"
          }

          github_headers = {
              "Authorization": f"token {GITHUB_TOKEN}",
              "Accept": "application/vnd.github.v3+json"
          }

          def get_github_issues():
              url = f"https://api.github.com/repos/{REPO}/issues"
              params = {"state": "open", "per_page": 100}
              try:
                  response = requests.get(url, headers=github_headers, params=params)
                  if response.status_code == 200:
                      return [i for i in response.json() if 'pull_request' not in i]
              except Exception as e:
                  print(f"Error fetching issues: {e}")
              return []

          def get_notion_items():
              url = f"https://api.notion.com/v1/databases/{DATABASE_ID}/query"
              try:
                  response = requests.post(url, headers=notion_headers, json={"page_size": 100})
                  if response.status_code == 200:
                      items = {}
                      for item in response.json().get('results', []):
                          props = item.get('properties', {})
                          gh_num = props.get('GitHub Issue', {}).get('number')
                          if gh_num:
                              items[gh_num] = item.get('id')
                      return items
              except Exception as e:
                  print(f"Error fetching Notion items: {e}")
              return {}

          def create_notion_page(issue):
              status = "To Do"
              priority = "Medium"

              for label in issue.get('labels', []):
                  name = label.get('name', '').lower()
                  if 'in progress' in name:
                      status = "In Progress"
                  elif 'done' in name:
                      status = "Done"
                  elif 'high' in name or 'critical' in name:
                      priority = "High"
                  elif 'low' in name:
                      priority = "Low"

              payload = {
                  "parent": {"database_id": DATABASE_ID},
                  "properties": {
                      "Name": {"title": [{"text": {"content": issue.get('title', '')[:2000]}}]},
                      "Status": {"select": {"name": status}},
                      "Priority": {"select": {"name": priority}},
                      "GitHub Issue": {"number": issue.get('number', 0)},
                      "GitHub URL": {"url": issue.get('html_url', '')}
                  }
              }

              url = "https://api.notion.com/v1/pages"
              response = requests.post(url, headers=notion_headers, json=payload)
              return response.status_code == 200

          # Main sync
          github_issues = get_github_issues()
          notion_items = get_notion_items()
          synced = 0

          for issue in github_issues:
              num = issue.get('number')
              if num not in notion_items:
                  if create_notion_page(issue):
                      synced += 1
                      print(f"Created Notion page for issue #{num}")

          print(f"Notion sync complete. Created {synced} new pages.")
          EOF

          echo "Notion sync complete"

  # Notify on completion (optional)
  notify:
    name: Notify on Completion
    runs-on: ubuntu-latest
    needs: [scheduled-sync, notion-sync]
    if: always() && github.event_name == 'schedule'

    steps:
      - name: Send Notification
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"GitHub Projects board sync completed for Investment Analysis Platform"}' \
              "$SLACK_WEBHOOK_URL" || true
          fi

      - name: Generate Final Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All board synchronization tasks completed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Target | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Projects | ${{ needs.scheduled-sync.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Notion Database | ${{ needs.notion-sync.result }} |" >> $GITHUB_STEP_SUMMARY
