name: Type Check

on:
  push:
    branches: [main, develop, 'add-claude-github-actions-*']
    paths:
      - 'backend/**/*.py'
      - '.mypy.ini'
      - 'backend/requirements*.txt'
  pull_request:
    branches: [main, develop]
    paths:
      - 'backend/**/*.py'
      - '.mypy.ini'
      - 'backend/requirements*.txt'

jobs:
  mypy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install mypy lxml
          if [ -f backend/requirements.txt ]; then pip install -r backend/requirements.txt; fi
          if [ -f backend/requirements-dev.txt ]; then pip install -r backend/requirements-dev.txt; fi

      - name: Run mypy type checking
        id: mypy
        run: |
          mkdir -p mypy-report
          mypy backend/ --config-file=.mypy.ini --html-report ./mypy-report --cobertura-xml-report ./mypy-report || true

          # Count errors
          ERROR_COUNT=$(mypy backend/ --config-file=.mypy.ini 2>&1 | grep -oP 'Found \K\d+(?= errors)' || echo "0")
          echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
          echo "### MyPy Type Check Results" >> $GITHUB_STEP_SUMMARY
          echo "Found $ERROR_COUNT type errors" >> $GITHUB_STEP_SUMMARY

          # Baseline is 3636 errors - allow up to 10% increase
          BASELINE=3636
          THRESHOLD=$((BASELINE + BASELINE / 10))

          if [ "$ERROR_COUNT" -gt "$THRESHOLD" ]; then
            echo "‚ùå Type errors increased beyond threshold! Current: $ERROR_COUNT, Baseline: $BASELINE, Threshold: $THRESHOLD" >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [ "$ERROR_COUNT" -gt "$BASELINE" ]; then
            echo "‚ö†Ô∏è Type errors increased but within threshold. Current: $ERROR_COUNT, Baseline: $BASELINE" >> $GITHUB_STEP_SUMMARY
          elif [ "$ERROR_COUNT" -lt "$BASELINE" ]; then
            echo "‚úÖ Type errors decreased! Current: $ERROR_COUNT, Baseline: $BASELINE (Improvement: $((BASELINE - ERROR_COUNT)) errors)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ Type errors unchanged at baseline: $BASELINE" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload mypy report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mypy-html-report
          path: mypy-report/
          retention-days: 7

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const errorCount = '${{ steps.mypy.outputs.error_count }}';
            const baseline = 3636;
            const diff = errorCount - baseline;
            const emoji = diff > 0 ? '‚ö†Ô∏è' : diff < 0 ? '‚úÖ' : '‚úîÔ∏è';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body: `## ${emoji} MyPy Type Check Results\n\n` +
                    `**Current:** ${errorCount} errors\n` +
                    `**Baseline:** ${baseline} errors\n` +
                    `**Change:** ${diff > 0 ? '+' : ''}${diff} errors\n\n` +
                    `[View detailed report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
            })

      - name: Update baseline if improved
        if: steps.mypy.outputs.error_count < 3636
        run: |
          echo "üéâ Type errors reduced! Consider updating baseline in workflow." >> $GITHUB_STEP_SUMMARY
          echo "Current: ${{ steps.mypy.outputs.error_count }}, Previous baseline: 3636" >> $GITHUB_STEP_SUMMARY
