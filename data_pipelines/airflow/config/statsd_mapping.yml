# StatsD to Prometheus Mapping Configuration for Airflow
# This file maps Airflow StatsD metrics to Prometheus metrics
# Usage with prometheus/statsd_exporter for monitoring Airflow metrics

mappings:
  # DAG-related metrics
  - match: "airflow.dag.*.*.duration"
    name: "airflow_dag_duration_seconds"
    labels:
      dag_id: "$1"
      task_id: "$2"
    help: "Duration of DAG task execution in seconds"

  - match: "airflow.dag_processing.last_duration.*"
    name: "airflow_dag_processing_duration_seconds"
    labels:
      dag_file: "$1"
    help: "Time spent processing DAG file in seconds"

  - match: "airflow.dag_processing.last_run.success_count.*"
    name: "airflow_dag_processing_success_total"
    labels:
      dag_file: "$1"
    help: "Number of successful DAG processing runs"

  - match: "airflow.dag_processing.last_run.error_count.*"
    name: "airflow_dag_processing_error_total"
    labels:
      dag_file: "$1"
    help: "Number of failed DAG processing runs"

  # Task Instance metrics
  - match: "airflow.ti.start.*.*"
    name: "airflow_task_start_total"
    labels:
      dag_id: "$1"
      task_id: "$2"
    help: "Number of task instances started"

  - match: "airflow.ti.finish.*.*.*"
    name: "airflow_task_finish_total"
    labels:
      dag_id: "$1"
      task_id: "$2"
      state: "$3"
    help: "Number of task instances finished by state"

  - match: "airflow.ti_failures"
    name: "airflow_task_failures_total"
    help: "Total number of task instance failures"

  - match: "airflow.ti_successes"
    name: "airflow_task_successes_total"
    help: "Total number of task instance successes"

  # Scheduler metrics
  - match: "airflow.scheduler.critical_section_duration"
    name: "airflow_scheduler_critical_section_duration_seconds"
    help: "Time spent in scheduler critical section"

  - match: "airflow.scheduler.dag_processing.processes"
    name: "airflow_scheduler_dag_processing_processes"
    help: "Number of DAG processing processes"

  - match: "airflow.scheduler.tasks.killed_externally"
    name: "airflow_scheduler_tasks_killed_externally_total"
    help: "Number of tasks killed externally"

  - match: "airflow.scheduler.tasks.running"
    name: "airflow_scheduler_tasks_running"
    help: "Number of running tasks"

  - match: "airflow.scheduler.tasks.starving"
    name: "airflow_scheduler_tasks_starving"
    help: "Number of starving tasks"

  - match: "airflow.scheduler.orphaned_tasks.cleared"
    name: "airflow_scheduler_orphaned_tasks_cleared_total"
    help: "Number of orphaned tasks cleared"

  - match: "airflow.scheduler.orphaned_tasks.adopted"
    name: "airflow_scheduler_orphaned_tasks_adopted_total"
    help: "Number of orphaned tasks adopted"

  # Executor metrics (for CeleryExecutor)
  - match: "airflow.executor.open_slots"
    name: "airflow_executor_open_slots"
    help: "Number of open executor slots"

  - match: "airflow.executor.queued_tasks"
    name: "airflow_executor_queued_tasks"
    help: "Number of queued tasks in executor"

  - match: "airflow.executor.running_tasks"
    name: "airflow_executor_running_tasks"
    help: "Number of running tasks in executor"

  # Pool metrics
  - match: "airflow.pool.open_slots.*"
    name: "airflow_pool_open_slots"
    labels:
      pool: "$1"
    help: "Number of open slots in pool"

  - match: "airflow.pool.queued_slots.*"
    name: "airflow_pool_queued_slots"
    labels:
      pool: "$1"
    help: "Number of queued slots in pool"

  - match: "airflow.pool.running_slots.*"
    name: "airflow_pool_running_slots"
    labels:
      pool: "$1"
    help: "Number of running slots in pool"

  # Database metrics
  - match: "airflow.dag_processing.manager_stalls"
    name: "airflow_dag_processing_manager_stalls_total"
    help: "Number of DAG processing manager stalls"

  - match: "airflow.scheduler.heartbeat"
    name: "airflow_scheduler_heartbeat_total"
    help: "Scheduler heartbeat counter"

  # Smart sensor metrics
  - match: "airflow.smart_sensor_operator.poked_tasks"
    name: "airflow_smart_sensor_poked_tasks_total"
    help: "Number of tasks poked by smart sensor"

  - match: "airflow.smart_sensor_operator.poked_success"
    name: "airflow_smart_sensor_poked_success_total"
    help: "Number of successful smart sensor pokes"

  - match: "airflow.smart_sensor_operator.poked_exception"
    name: "airflow_smart_sensor_poked_exception_total"
    help: "Number of smart sensor poke exceptions"

  # Generic counter and timer metrics
  - match: "airflow.*.*.*.count"
    name: "airflow_generic_count_total"
    labels:
      component: "$1"
      subcomponent: "$2"
      metric: "$3"
    help: "Generic Airflow counter metric"

  - match: "airflow.*.*.duration"
    name: "airflow_generic_duration_seconds"
    labels:
      component: "$1"
      operation: "$2"
    help: "Generic Airflow duration metric in seconds"

  # Webserver metrics
  - match: "airflow.webserver.response_time.*"
    name: "airflow_webserver_response_time_seconds"
    labels:
      endpoint: "$1"
    help: "Webserver response time in seconds"

  # Catch-all for any other Airflow metrics
  - match: "airflow.*"
    name: "airflow_unmatched_metric"
    labels:
      metric_name: "$0"
    help: "Unmatched Airflow metric (consider adding specific mapping)"

# Global configuration
defaults:
  timer_type: histogram
  buckets: [0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10, 30, 60, 120, 300]
  match_type: glob
  glob_disable_ordering: false
  ttl: 0  # No TTL for metrics