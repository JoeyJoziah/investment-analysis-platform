version: '3.8'

# Development-specific configuration
# Use with: docker-compose -f docker-compose.yml -f docker-compose.development.yml up

services:
  postgres:
    ports:
      - "5432:5432"  # Expose PostgreSQL for local development
    environment:
      POSTGRES_PASSWORD: ${DEV_DB_PASSWORD}
    volumes:
      - ./scripts/init_db.sql:/docker-entrypoint-initdb.d/init.sql
      - postgres_dev_data:/var/lib/postgresql/data

  redis:
    ports:
      - "6379:6379"  # Expose Redis for local development
    command: redis-server --appendonly yes --loglevel debug

  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
      target: development  # Use development stage
    volumes:
      - ./backend:/app/backend  # Mount source code for hot reload
      - ./scripts:/app/scripts
      - ./requirements.txt:/app/requirements.txt
    environment:
      - DEBUG=True
      - LOG_LEVEL=DEBUG
      - RELOAD=True
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    command: >
      sh -c "
        pip install --no-cache-dir -r requirements.txt &&
        python -m uvicorn backend.api.main:app --reload --host 0.0.0.0 --port 8000 --log-level debug
      "
    ports:
      - "8000:8000"  # Expose API for development

  frontend:
    build:
      context: ./frontend/web
      dockerfile: Dockerfile
      target: development  # Use development stage
    volumes:
      - ./frontend/web/src:/app/src  # Mount source for hot reload
      - ./frontend/web/public:/app/public
      - /app/node_modules  # Exclude node_modules from bind mount
    environment:
      - NODE_ENV=development
      - REACT_APP_API_URL=http://localhost:8000
      - CHOKIDAR_USEPOLLING=true  # For file watching in Docker
    ports:
      - "3000:3000"  # Expose React dev server
    command: npm start

  celery_worker:
    build:
      context: .
      dockerfile: Dockerfile.backend
      target: development
    volumes:
      - ./backend:/app/backend
      - ./scripts:/app/scripts
    environment:
      - DEBUG=True
      - LOG_LEVEL=DEBUG
      - C_FORCE_ROOT=true
    command: celery -A backend.tasks.celery_app worker --loglevel=debug --concurrency=2

  celery_beat:
    build:
      context: .
      dockerfile: Dockerfile.backend
      target: development
    volumes:
      - ./backend:/app/backend
      - ./scripts:/app/scripts
    environment:
      - DEBUG=True
      - LOG_LEVEL=DEBUG
    command: celery -A backend.tasks.celery_app beat --loglevel=debug

  flower:
    # Celery monitoring tool for development
    image: mher/flower:latest
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - FLOWER_PORT=5555
    ports:
      - "5555:5555"  # Flower web UI
    depends_on:
      - redis
      - celery_worker
    networks:
      - backend-network

  mailhog:
    # Email testing tool for development
    image: mailhog/mailhog:latest
    ports:
      - "1025:1025"  # SMTP server
      - "8025:8025"  # Web UI
    networks:
      - backend-network

  pgadmin:
    # PostgreSQL admin tool for development
    image: dpage/pgadmin4:latest
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@localhost.com
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - backend-network

  redis-commander:
    # Redis admin tool for development
    image: rediscommander/redis-commander:latest
    environment:
      - REDIS_HOSTS=local:redis:6379
    ports:
      - "8081:8081"
    depends_on:
      - redis
    networks:
      - backend-network

volumes:
  postgres_dev_data:
    driver: local
  pgadmin_data:
    driver: local

networks:
  backend-network:
    driver: bridge
  frontend-network:
    driver: bridge